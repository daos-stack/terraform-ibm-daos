# VPC Example

## About

Use this Terraform configuration to create a VPC that can be used to deploy the DAOS Cluster example in [examples/daos_cluster](../daos_cluster/README.md)

This Terraform configuration will create a multi-zone VPC in one region.

![](ibm_multi-zone_vpc.png)

- Within one region a subnet will be created for each zone.
- The VCP will have 3 security groups
  - A default security group - Typically this will not be used.
  - A bastion security group - Should be attached to the daos-admin instance. This allows ingress SSH from specific CIDRs to the daos-admin instance.
  - An instance security group - Should be attached to DAOS servers and clients. Allows ingress tcp communication from the subnet only.

## Instructions for creating the VPC

1. Create the terraform.tfvars file and modify the `terraform.tfvars`  file by replacing the values in `< >` brackets with your specific settings.

   ```bash
   cd examples/vpc
   cp terraform.tfvars.example terraform.tfvars
   sed -i "s/<resource_prefix>/${USER}/g" terraform.tfvars
   sed -i "s/<ibmcloud_api_key>/${IBMCLOUD_API_KEY}/g" terraform.tfvars
   ```

   It is recommended that you use your username for the `resource_prefix` variable. This will allow you to identify your VPC resources in a multi-user environment.

   If you don't have the `IBMCLOUD_API_KEY` environment variable set in your shell, you will need to edit the `terraform.tfvars` file and update the `ibmcloud_api_key` value.


   The `bastion_sg_ssh_allowed_ips` variable contains a list of CIDRs that you will allow ingress on port 22. This list of CIDRs will be added to the bastion security group which will be attached to the daos-admin instance.

   > NOTE!
   > In the `terraform.tfvars.example` file the `bastion_sg_ssh_allowed_ips` variable value is commented out. The commented value contains the CIDR `0.0.0.0/0` which allows any host on the internet ingress on port 22 to any instance that contains a floating IP and is associated with the security group. It is highly recommended not to use this setting. Only use specific IPs or CIDRs for your company's proxy servers or the current IP of your workstation.


2. Create the VPC

   ```bash
   terraform init
   terraform plan
   terraform apply
   ```

3. Note the outputs from Terraform

   Make a note of the output values from the Terraform state.

   These values will be needed in the `terraform.tfvars` file for the the [examples/daos_cluster](../daos_cluster/README.md) configuration.

   You can always run

   ```bash
   terraform output
   ```

   in the `examples/vpc` directory later to view the output values again.


## Terraform Reference

The following reference documentation was generated by a pre-commit hook.

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
Copyright 2022 Intel Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_ibm"></a> [ibm](#requirement\_ibm) | 1.46.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_ibm"></a> [ibm](#provider\_ibm) | 1.46.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [ibm_is_network_acl.allow_all](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_network_acl) | resource |
| [ibm_is_public_gateway.daos_gw](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_public_gateway) | resource |
| [ibm_is_security_group.bastion](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group) | resource |
| [ibm_is_security_group.instance](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group) | resource |
| [ibm_is_security_group_rule.bastion_egress_all](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group_rule) | resource |
| [ibm_is_security_group_rule.bastion_ingress_ssh](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group_rule) | resource |
| [ibm_is_security_group_rule.instance_egress](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group_rule) | resource |
| [ibm_is_security_group_rule.instance_ingress](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_security_group_rule) | resource |
| [ibm_is_subnet.daos_sn](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_subnet) | resource |
| [ibm_is_vpc.daos_vpc](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/resources/is_vpc) | resource |
| [ibm_is_region.region](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/data-sources/is_region) | data source |
| [ibm_is_zones.regional_zones](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/data-sources/is_zones) | data source |
| [ibm_resource_group.daos_rg](https://registry.terraform.io/providers/IBM-Cloud/ibm/1.46.0/docs/data-sources/resource_group) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_bastion_sg_ssh_allowed_ips"></a> [bastion\_sg\_ssh\_allowed\_ips](#input\_bastion\_sg\_ssh\_allowed\_ips) | Allowed CIDRs for ingress rules to the bastion Security Group | <pre>list(object({<br>    name = string<br>    cidr = string<br>  }))</pre> | <pre>[<br>  {<br>    "cidr": "0.0.0.0/0",<br>    "name": "ANY"<br>  }<br>]</pre> | no |
| <a name="input_ibmcloud_timeout"></a> [ibmcloud\_timeout](#input\_ibmcloud\_timeout) | The timeout, expressed in seconds, for interacting with IBM Cloud APIs | `number` | `900` | no |
| <a name="input_region"></a> [region](#input\_region) | IBM Cloud Region where resources will be deployed | `string` | `"us-south"` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | The name of the resource group | `string` | `"Default"` | no |
| <a name="input_resource_prefix"></a> [resource\_prefix](#input\_resource\_prefix) | String that is prepended to all resource names | `string` | n/a | yes |
| <a name="input_subnet_total_ipv4_address_count"></a> [subnet\_total\_ipv4\_address\_count](#input\_subnet\_total\_ipv4\_address\_count) | Total number of IPv4 addresses per subnet | `number` | `256` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_bastion_sg_name"></a> [bastion\_sg\_name](#output\_bastion\_sg\_name) | The name of the bastion security group |
| <a name="output_crn"></a> [crn](#output\_crn) | The CRN of the VPC |
| <a name="output_id"></a> [id](#output\_id) | The ID of the VPC |
| <a name="output_instance_sg_name"></a> [instance\_sg\_name](#output\_instance\_sg\_name) | The name of the instance security group |
| <a name="output_name"></a> [name](#output\_name) | The name of the VPC |
| <a name="output_region"></a> [region](#output\_region) | IBM Cloud region |
| <a name="output_subnet_names"></a> [subnet\_names](#output\_subnet\_names) | The names of the subnets in the VPC |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
